<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <style>
      body { font-family: system-ui, sans-serif; margin: 0; }
      .wrap { width: 360px; padding: 12px; }
      h1 { font-size: 15px; margin: 0 0 8px; }
      label { display:block; font-size: 12px; margin-top: 10px; font-weight: bold; }
      input, textarea { width: 100%; box-sizing: border-box; padding: 8px; }
      textarea { height: 64px; resize: vertical; }
      button { width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; }
      button.primary { background: #1a73e8; color: white; border: none; border-radius: 4px; }
      button.primary:hover { background: #1557b0; }
      button.danger { background: #d93025; color: white; border: none; border-radius: 4px; }
      button.danger:hover { background: #b3221b; }
      button.execute { background: #ff9800; color: white; border: none; border-radius: 4px; }
      button.execute:hover:not(:disabled) { background: #e68900; }
      button.execute:disabled { background: #ccc; color: #888; cursor: not-allowed; }
      button.stop { background: #d93025; color: white; border: none; border-radius: 4px; display: none; }
      button.stop:hover { background: #b3221b; }
      .debug-section { margin-top: 10px; border: 1px solid #c5cae9; border-radius: 6px; overflow: hidden; }
      .debug-header { font-size: 12px; font-weight: bold; padding: 7px 10px; background: #e8eaf6; border-bottom: 1px solid #c5cae9; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
      .debug-header:hover { background: #dde1f5; }
      .debug-body { display: none; }
      .debug-body.open { display: block; }
      .debug-summary { font-size: 11px; padding: 5px 10px; background: #f3f4fd; border-bottom: 1px solid #e0e0e0; color: #3949ab; }
      .debug-step { border-bottom: 1px solid #eee; }
      .debug-step:last-child { border-bottom: none; }
      .debug-step summary { cursor: pointer; font-size: 11px; font-weight: bold; padding: 6px 10px; color: #3949ab; }
      .debug-step summary:hover { background: #f3f4fd; }
      .debug-pre { margin: 0; padding: 8px 10px; font-size: 10px; max-height: 260px; overflow-y: auto; background: #fafafa; white-space: pre-wrap; word-break: break-all; }
      .auto-run-row { display: flex; gap: 6px; margin-top: 10px; align-items: center; }
      .auto-run-row button { flex: 1; margin-top: 0; }
      .auto-run-row input { width: 60px; flex: 0 0 60px; text-align: center; padding: 8px 4px; }
      .auto-run-row label { flex: 0 0 auto; font-size: 11px; margin: 0; white-space: nowrap; }
      .step-counter { font-size: 11px; color: #666; margin-top: 4px; display: none; }
      .flow-section { margin-top: 10px; border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; }
      .flow-header { font-size: 12px; font-weight: bold; padding: 8px 10px; background: #f5f5f5; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
      .flow-nav { display: flex; align-items: center; gap: 6px; font-weight: normal; }
      .flow-nav-btn { width: 22px; height: 22px; border: 1px solid #ccc; border-radius: 4px; background: white; cursor: pointer; font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center; padding: 0; }
      .flow-nav-btn:hover:not(:disabled) { background: #e8f0fe; border-color: #1a73e8; }
      .flow-nav-btn:disabled { opacity: 0.3; cursor: default; }
      #flowStepLabel { font-size: 11px; min-width: 70px; text-align: center; }
      .flow-step { border-bottom: 1px solid #eee; }
      .flow-step:last-child { border-bottom: none; }
      .flow-step summary { cursor: pointer; font-size: 12px; padding: 6px 10px; display: flex; align-items: center; gap: 6px; }
      .flow-step summary:hover { background: #fafafa; }
      .flow-badge { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; border-radius: 50%; font-size: 10px; font-weight: bold; color: white; flex-shrink: 0; }
      .step-input .flow-badge { background: #1a73e8; }
      .step-output .flow-badge { background: #34a853; }
      .badge-observe { background: #f57c00 !important; }
      .flow-pre { margin: 0; padding: 8px 10px; font-size: 11px; max-height: 300px; overflow-y: auto; border-top: 1px solid #eee; background: #fafafa; }
      .exec-result { font-size: 11px; padding: 6px 8px; border-radius: 4px; margin-top: 6px; display: none; }
      .exec-result.success { display: block; background: #e8f5e9; color: #2e7d32; }
      .exec-result.error { display: block; background: #fbe9e7; color: #c62828; }
      pre { white-space: pre-wrap; background:#f6f6f6; padding:8px; border-radius:6px; font-size:12px; }
      .task-info { background: #e8f0fe; padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 12px; }
      .task-info strong { display: block; margin-bottom: 4px; }
      details { margin-top: 6px; }
      details summary { cursor: pointer; font-size: 12px; color: #555; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>UX Capture + AI</h1>

      <!-- Task ÏÑ∏ÏÖò ÏòÅÏó≠ -->
      <div id="taskSection">
        <label>Task Ïù¥Î¶Ñ</label>
        <input id="taskName" placeholder="Ïòà: ÎÑ§Ïù¥Î≤ÑÏáºÌïë ÎÖ∏Ìä∏Î∂Å Í≤ÄÏÉâ ÌîåÎ°úÏö∞" />
        <button id="startTask" class="primary">Task ÏãúÏûë</button>
      </div>

      <!-- Task ÏßÑÌñâ Ï§ëÏùº ÎïåÎßå ÌëúÏãú -->
      <div id="activeTaskSection" style="display:none">
        <div class="task-info">
          <strong>ÏßÑÌñâ Ï§ë Task: <span id="currentTaskName"></span></strong>
          <small>Ï∫°Ï≤ò ÌöüÏàò: <span id="captureCount">0</span></small>
        </div>

        <div class="auto-run-row">
          <button id="autoRun" class="primary">Auto Run</button>
          <button id="stopRun" class="stop">Stop</button>
          <label>Max</label>
          <input id="maxSteps" type="number" value="20" min="1" max="100" />
        </div>
        <div id="stepCounter" class="step-counter">Step <span id="currentStep">0</span> / <span id="maxStepDisplay">20</span></div>

        <button id="captureViewport" class="primary" style="font-size:12px; padding:6px;">ÏàòÎèô Ï∫°Ï≤ò</button>
        <button id="endTask" class="danger">Task Ï¢ÖÎ£å</button>
      </div>

      <!-- ÏÉÅÌÉú Î©îÏãúÏßÄ -->
      <pre id="out" style="font-size:11px; color:#666;">Ready.</pre>

      <!-- Agent Flow: 6Îã®Í≥Ñ ÏÇ¨Í≥†Í≥ºÏ†ï (Observe ‚Üí Reasoning ‚Üí Action) -->
      <div class="flow-section">
        <div class="flow-header">
          <span>Agent Flow</span>
          <div id="flowNav" class="flow-nav" style="display:none">
            <button id="flowPrev" class="flow-nav-btn" title="Ïù¥Ï†Ñ Step">&lsaquo;</button>
            <span id="flowStepLabel">Step 1 / 1</span>
            <button id="flowNext" class="flow-nav-btn" title="Îã§Ïùå Step">&rsaquo;</button>
          </div>
        </div>

        <!-- Step 1: Observe Input -->
        <details class="flow-step step-input">
          <summary><span class="flow-badge badge-observe">1</span> Observe Input</summary>
          <pre id="observeInput" class="flow-pre">(empty)</pre>
        </details>

        <!-- Step 2: Observe Output -->
        <details class="flow-step step-output" open>
          <summary><span class="flow-badge badge-observe">2</span> Observe Output</summary>
          <pre id="observeOut" class="flow-pre">(empty)</pre>
        </details>

        <!-- Step 3: Reasoning Input -->
        <details class="flow-step step-input">
          <summary><span class="flow-badge">3</span> Reasoning Input</summary>
          <pre id="reasoningInput" class="flow-pre">(empty)</pre>
        </details>

        <!-- Step 4: Reasoning Output -->
        <details class="flow-step step-output" open>
          <summary><span class="flow-badge">4</span> Reasoning Output</summary>
          <pre id="reasoningOut" class="flow-pre">(empty)</pre>
        </details>

        <!-- Step 5: Action Input -->
        <details class="flow-step step-input">
          <summary><span class="flow-badge">5</span> Action Input</summary>
          <pre id="actionInput" class="flow-pre">(empty)</pre>
        </details>

        <!-- Step 6: Action Output -->
        <details class="flow-step step-output" open>
          <summary><span class="flow-badge">6</span> Action Output</summary>
          <pre id="actionOut" class="flow-pre">(empty)</pre>
        </details>
      </div>

      <button id="executeAction" class="execute" disabled>Ïï°ÏÖò Ïã§Ìñâ</button>
      <div id="execResult" class="exec-result"></div>

      <!-- Debug Panel -->
      <div class="debug-section">
        <div class="debug-header" id="debugToggle">
          <span>üîç Debug</span>
          <span id="debugToggleIcon">‚ñº</span>
        </div>
        <div class="debug-body" id="debugBody">
          <div class="debug-summary" id="debugSummary">Ï∫°Ï≤ò ÌõÑ ÌëúÏãúÎê©ÎãàÎã§.</div>

          <!-- AX Extract Raw -->
          <details class="debug-step">
            <summary>AX Extract (ax-extract.js Í≤∞Í≥º)</summary>
            <details class="debug-step" style="border:none;">
              <summary style="padding-left:20px; color:#555;">activeLayer</summary>
              <pre id="dbgActiveLayer" class="debug-pre">(empty)</pre>
            </details>
            <details class="debug-step" style="border:none;">
              <summary style="padding-left:20px; color:#555;">blocks</summary>
              <pre id="dbgBlocks" class="debug-pre">(empty)</pre>
            </details>
            <details class="debug-step" style="border:none;">
              <summary style="padding-left:20px; color:#555;">overlayTexts</summary>
              <pre id="dbgOverlayTexts" class="debug-pre">(empty)</pre>
            </details>
            <details class="debug-step" style="border:none;">
              <summary style="padding-left:20px; color:#555;">interactive_elements (ÏÉÅÏúÑ 10Í∞ú)</summary>
              <pre id="dbgElements" class="debug-pre">(empty)</pre>
            </details>
          </details>

          <!-- Observation Assembled -->
          <details class="debug-step">
            <summary>Observation (buildObservation Í≤∞Í≥º)</summary>
            <pre id="dbgObservation" class="debug-pre">(empty)</pre>
          </details>
        </div>
      </div>
    </div>

    <script src="sidepanel.js"></script>
  </body>
</html>
